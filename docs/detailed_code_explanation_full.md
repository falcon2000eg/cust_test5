# شرح مفصل جدًا لكود نظام إدارة مشاكل العملاء

---

## 1. customer_issues_main.py (التطبيق الرئيسي)

### المتغيرات الرئيسية:
- `VERSION`: رقم إصدار النظام.
- `CURRENT_DIR`: مسار تشغيل البرنامج (يدعم exe أو كود بايثون).

### الدوال والإجراءات:
- **setup_logging()**: إعداد نظام السجلات (logs) في مجلد logs/ مع طباعة الأحداث والأخطاء.
- **check_requirements()**: فحص إصدار بايثون والمكتبات المطلوبة، وإظهار رسالة خطأ إذا كان هناك نقص.
- **create_backup()**: إنشاء نسخة احتياطية من قاعدة البيانات في مجلد backups/ والاحتفاظ بآخر 10 نسخ فقط.
- **initialize_system()**: تهيئة المجلدات الأساسية، إنشاء نسخة احتياطية، وتهيئة قاعدة البيانات عبر DatabaseManager.
- **show_splash_screen()**: عرض شاشة البداية (Splash) مع معلومات النظام والمطور.
- **main()**: نقطة بدء التنفيذ، تنفذ جميع الخطوات السابقة، ثم تستورد وتطلق الواجهة الرئيسية (`EnhancedMainWindow`).
    - ينشئ نافذة root مخفية.
    - يعرض splash screen.
    - يفحص المتطلبات.
    - يهيئ النظام وقاعدة البيانات.
    - يستورد ويشغل الواجهة الرئيسية.
    - عند الإغلاق: ينشئ نسخة احتياطية.

### الاستدعاءات:
- استيراد `DatabaseManager` من customer_issues_database.py لتهيئة قاعدة البيانات.
- استيراد `EnhancedMainWindow` من customer_issues_window.py لتشغيل الواجهة.

### ملخص سير العمل:
1. إعداد السجلات.
2. فحص المتطلبات.
3. تهيئة النظام وقاعدة البيانات.
4. عرض شاشة البداية.
5. تشغيل الواجهة الرئيسية.
6. عند الإغلاق: إنشاء نسخة احتياطية.

---

## 2. customer_issues_window.py (واجهة المستخدم)

### المتغيرات الرئيسية:
- `self.root`: نافذة Tkinter الرئيسية.
- `self.file_manager`: كائن لإدارة الملفات والمرفقات.
- `self.functions`: كائن الوظائف المنطقية (EnhancedFunctions).
- متغيرات الحالة مثل: `current_case_id`, `cases_data`, `filtered_cases`, `basic_data_widgets`, `settings`, `year_var`, `search_type_var`, `search_value_var`, `search_entry`, `search_combo`, `sort_var`, `sort_combo`, `scrollable_frame`, `cases_canvas`, `cases_scrollbar`, `selected_case_index`, `case_card_widgets`, `customer_name_label`, `solved_by_label`, `save_btn`, `print_btn`, `notebook`, `employee_var`.

### الدوال والإجراءات (أهمها):
- **__init__()**: تهيئة النافذة، الخطوط، المتغيرات، ربط الوظائف، بناء الواجهة، تحميل البيانات، ربط أحداث الإغلاق.
- **setup_fonts()**: إعداد الخطوط العربية الاحترافية للواجهة.
- **create_main_layout()**: بناء التخطيط الرئيسي (لوحة جانبية، منطقة عرض رئيسية).
- **create_sidebar()**: بناء اللوحة الجانبية (قائمة الحالات، أزرار الإجراءات، البحث).
- **create_action_buttons()**: أزرار إضافة/حذف حالة، إدارة الموظفين.
- **create_search_filters()**: أدوات البحث والفلترة (سنة، نوع التاريخ، نوع البحث).
- **create_cases_list()**: بناء قائمة الحالات مع دعم التمرير.
- **add_case_card()**: إضافة بطاقة حالة للقائمة.
- **create_main_display()**: بناء منطقة العرض الرئيسية (رأس، أزرار، تبويبات).
- **create_display_header()**: رأس العرض (اسم العميل، الموظف المسؤول).
- **create_display_buttons()**: أزرار العمليات (حفظ، طباعة).
- **create_tabs()**: بناء التبويبات (بيانات أساسية، مرفقات، مراسلات، سجل تعديلات).
- **create_basic_data_tab()**: تبويب البيانات الأساسية (حقول العميل، المشكلة، العداد، الموظف).
- **create_attachments_tab()**: تبويب المرفقات.
- **create_correspondences_tab()**: تبويب المراسلات.
- **create_audit_log_tab()**: تبويب سجل التعديلات.
- **add_new_case()**: إضافة حالة جديدة.
- **add_attachment()**: إضافة مرفق لحالة.
- **perform_search()**: تنفيذ البحث في الحالات.
- **on_closing()**: معالجة إغلاق البرنامج (حفظ التغييرات/النسخ الاحتياطي).
- **save_changes()**: حفظ التعديلات على الحالة.
- **delete_case()**: حذف حالة.
- **show_settings_window()**: نافذة إعدادات مسار المرفقات.
- **apply_sorting()**: ترتيب الحالات حسب السنة أو الاسم.
- **update_year_filter_options()**: تحديث خيارات الفلترة حسب نوع التاريخ.
- **manage_employees()**: إدارة الموظفين (إضافة/حذف).
- **print_case()**: طباعة بيانات الحالة.
- **run()**: بدء حلقة الأحداث الرئيسية للواجهة.

### الاستدعاءات:
- استدعاء `EnhancedFunctions` من customer_issues_functions.py.
- استدعاء `FileManager` من customer_issues_file_manager.py.
- استدعاء دوال قاعدة البيانات عبر الوظائف المنطقية.

### أجزاء الكود الرئيسية:
- بناء الواجهة (قوائم، تبويبات، حقول بيانات، مرفقات، مراسلات).
- إدارة الأحداث (زر، بحث، إغلاق، إضافة/حذف).
- التعامل مع الإعدادات (config.json).
- دعم التمرير، الترتيب، البحث المتقدم، التبويبات، الطباعة.

---

## 3. customer_issues_functions.py (الوظائف المنطقية)

### المتغيرات الرئيسية:
- `self.main_window`: مرجع للنافذة الرئيسية للتفاعل مع عناصر الواجهة.
- `self.categories_data`, `self.status_data`: بيانات التصنيفات والحالات للبحث والعرض.

### الدوال والإجراءات (أهمها):
- **load_initial_data()**: تحميل السنوات، التصنيفات، الحالات، خيارات الحالة.
- **load_years()**: تحميل السنوات المتاحة من قاعدة البيانات.
- **load_categories()**: تحميل تصنيفات المشاكل من قاعدة البيانات.
- **load_status_options()**: تحميل خيارات الحالة من قاعدة البيانات.
- **load_cases()**: تحميل الحالات (كل السنوات أو سنة محددة).
- **refresh_cases_display()**: تحديث عرض الحالات في الواجهة.
- **create_case_card()**: بناء بطاقة حالة في القائمة الجانبية.
- **select_case()**: اختيار حالة وعرض تفاصيلها.
- **load_case_details()**: تحميل تفاصيل حالة (بيانات، مرفقات، مراسلات، سجل تعديلات).
- **fill_basic_data()**: ملء حقول البيانات الأساسية في الواجهة.
- **load_case_attachments()**: تحميل مرفقات الحالة.
- **load_case_correspondences()**: تحميل مراسلات الحالة.
- **load_case_audit_log()**: تحميل سجل تعديلات الحالة.
- **filter_by_year()**: فلترة الحالات حسب السنة.
- **on_search_type_change()**: تغيير نوع البحث وتحديث الحقول.
- **perform_search()**: تنفيذ البحث في الحالات.
- **add_new_case()**: إضافة حالة جديدة لقاعدة البيانات.
- **EmployeeSelectionDialog**: نافذة اختيار الموظف المسؤول عن الحالة.

### الاستدعاءات:
- استدعاء دوال قاعدة البيانات عبر `enhanced_db` (مثل get_cases_by_year, get_categories, search_cases, log_action).
- استدعاء عناصر الواجهة عبر `self.main_window`.

### أجزاء الكود الرئيسية:
- تحميل البيانات من قاعدة البيانات.
- تحديث الواجهة بالبيانات.
- تنفيذ عمليات البحث والتصفية.
- إضافة/تعديل/حذف الحالات والمرفقات والمراسلات.
- دعم البحث المتقدم، الفلترة، الترتيب، سجل التعديلات.

---

## 4. customer_issues_file_manager.py (إدارة الملفات)

### المتغيرات الرئيسية:
- `self.base_path`: المسار الأساسي لمجلد الملفات (عادة files/).
- `PROJECT_ROOT`: مسار جذر المشروع.

### الدوال والإجراءات (أهمها):
- **ensure_base_directory()**: التأكد من وجود مجلد الملفات الأساسي.
- **create_case_folder(case_id)**: إنشاء مجلد جديد لحالة.
- **copy_file_to_dedicated_folder(source_path, case_id, attachments_base_path, description)**: نسخ ملف إلى مجلد الحالة.
- **get_attachment_info(file_path, description)**: جلب معلومات ملف مرفق دون نسخه.
- **select_and_copy_file(case_id, description)**: اختيار ونسخ ملف لحالة عبر نافذة حوار.
- **get_file_type(file_name)**: تحديد نوع الملف من الامتداد.
- **get_file_size(file_path)**: حساب حجم الملف بشكل مقروء.
- **open_case_folder(case_id)**: فتح مجلد حالة في النظام.
- **open_file(file_path)**: فتح ملف في النظام.
- **delete_file(file_path)**: حذف ملف من النظام.
- **move_file_to_case(source_path, target_case_id, description)**: نقل ملف من حالة لأخرى.
- **get_case_files_info(case_id)**: جلب معلومات جميع ملفات الحالة.
- **create_backup(case_id, backup_path=None)**: إنشاء نسخة احتياطية من ملفات الحالة.
- **cleanup_old_backups(days_to_keep=30)**: تنظيف النسخ الاحتياطية القديمة.
- **get_storage_info()**: جلب معلومات التخزين (عدد الملفات، الحجم الكلي).
- **format_size(size_bytes)**: تنسيق حجم الملف للعرض.

### الاستدعاءات:
- استدعاء دوال النظام (os, shutil) لإدارة الملفات والمجلدات.
- استدعاء رسائل واجهة المستخدم (messagebox) عند الحاجة.

### أجزاء الكود الرئيسية:
- إدارة المجلدات (إنشاء، فتح، حذف، نقل).
- إدارة المرفقات (نسخ، معلومات، حذف، نسخ احتياطي).
- دعم تعدد الأنظمة (Windows, macOS, Linux).
- حساب حجم التخزين وتنظيف النسخ القديمة.

---

## 5. customer_issues_database.py (مدير قاعدة البيانات)

### المتغيرات الرئيسية:
- `self.db_name`: اسم ملف قاعدة البيانات (عادة customer_issues_enhanced.db).

### الدوال والإجراءات (أهمها):
- **init_database()**: إنشاء الجداول الأساسية إذا لم تكن موجودة (الموظفين، التصنيفات، الحالات، المراسلات، المرفقات، سجل التعديلات).
- **execute_query(query, params=None)**: تنفيذ استعلام SQL عام وإرجاع النتائج.
- **get_connection()**: الحصول على اتصال بقاعدة البيانات.
- **add_case, update_case, delete_case**: إضافة/تعديل/حذف حالة.
- **get_cases_by_year, search_cases, get_case_details**: استعلامات لجلب الحالات.
- **add_attachment, get_attachments, delete_attachment**: إدارة المرفقات.
- **add_correspondence, get_correspondences, delete_correspondence**: إدارة المراسلات.
- **log_action, get_case_audit_log**: إدارة سجل التعديلات.
- **get_employees, add_employee, delete_employee**: إدارة الموظفين.
- **get_categories, get_status_options**: جلب التصنيفات وخيارات الحالة.
- **get_next_correspondence_numbers**: جلب أرقام المراسلة التالية.
- **get_all_cases**: جلب جميع الحالات.

### الاستدعاءات:
- استدعاء مكتبة sqlite3 لإدارة قاعدة البيانات.
- استدعاء datetime لحفظ التواريخ.

### أجزاء الكود الرئيسية:
- إنشاء الجداول وربطها بمفاتيح أجنبية.
- تنفيذ جميع العمليات على البيانات (CRUD).
- دعم إدخال بيانات افتراضية (موظفين، تصنيفات).
- دعم البحث المتقدم، الفلترة، الترتيب، سجل التعديلات.

---

## أمثلة وسيناريوهات عملية:

### إضافة حالة جديدة:
1. المستخدم يضغط زر "إضافة حالة جديدة" في الواجهة.
2. يتم استدعاء `add_new_case()` في EnhancedFunctions.
3. تظهر نافذة اختيار الموظف المسؤول.
4. يتم إدخال سجل جديد في جدول cases بقاعدة البيانات.
5. يتم تسجيل العملية في سجل التعديلات.
6. يتم تحديث قائمة الحالات في الواجهة.

### إضافة مرفق:
1. المستخدم يضغط زر "إضافة مرفق".
2. يتم استدعاء `add_attachment()` في EnhancedMainWindow.
3. تظهر نافذة اختيار الملف.
4. يتم نسخ الملف لمجلد الحالة عبر FileManager.
5. يتم إدخال سجل جديد في جدول attachments.
6. يتم تحديث تبويب المرفقات في الواجهة.

### البحث عن حالة:
1. المستخدم يحدد نوع البحث ويدخل القيمة.
2. يتم استدعاء `perform_search()` في EnhancedFunctions.
3. يتم تنفيذ استعلام بحث في قاعدة البيانات.
4. يتم عرض النتائج في قائمة الحالات.

### حذف حالة:
1. المستخدم يضغط زر "حذف الحالة".
2. يتم استدعاء `delete_case()` في EnhancedMainWindow.
3. يتم حذف السجلات المرتبطة من قاعدة البيانات (المرفقات، المراسلات، سجل التعديلات).
4. يتم حذف مجلد الحالة من الملفات.
5. يتم تحديث قائمة الحالات في الواجهة.

---

## ملخص ترابط الأجزاء:
- main.py يهيئ النظام ويشغل الواجهة.
- window.py يبني الواجهة ويتعامل مع المستخدم.
- functions.py ينفذ المنطق ويتعامل مع قاعدة البيانات والملفات.
- file_manager.py يدير المرفقات والمجلدات.
- database.py يدير كل البيانات والعلاقات.

---

## ملاحظات تقنية:
- جميع المسارات ديناميكية وتدعم العمل كـ exe أو كود بايثون.
- يدعم اللغة العربية بالكامل (واجهة وبيانات).
- قابل للتطوير والإضافة (تصنيفات، موظفين، تقارير، صلاحيات).
- يدعم النسخ الاحتياطي التلقائي وتنظيف النسخ القديمة.
- يدعم البحث المتقدم والتقارير وسجل التعديلات.

--- 