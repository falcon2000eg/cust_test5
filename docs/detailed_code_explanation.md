# شرح تفصيلي لكود نظام إدارة مشاكل العملاء

---

## 1. customer_issues_main.py (التطبيق الرئيسي)

### المتغيرات الرئيسية:
- `VERSION`: رقم إصدار النظام.
- `CURRENT_DIR`: مسار تشغيل البرنامج (يدعم exe أو كود بايثون).

### الدوال والإجراءات:
- **setup_logging()**: إعداد نظام السجلات (logs) في مجلد logs/ مع طباعة الأحداث والأخطاء.
- **check_requirements()**: فحص إصدار بايثون والمكتبات المطلوبة، وإظهار رسالة خطأ إذا كان هناك نقص.
- **create_backup()**: إنشاء نسخة احتياطية من قاعدة البيانات في مجلد backups/ والاحتفاظ بآخر 10 نسخ فقط.
- **initialize_system()**: تهيئة المجلدات الأساسية، إنشاء نسخة احتياطية، وتهيئة قاعدة البيانات عبر DatabaseManager.
- **show_splash_screen()**: عرض شاشة البداية (Splash) مع معلومات النظام والمطور.
- **main()**: نقطة بدء التنفيذ، تنفذ جميع الخطوات السابقة، ثم تستورد وتطلق الواجهة الرئيسية (`EnhancedMainWindow`).

### الاستدعاءات:
- استيراد `DatabaseManager` من customer_issues_database.py لتهيئة قاعدة البيانات.
- استيراد `EnhancedMainWindow` من customer_issues_window.py لتشغيل الواجهة.

### ملخص سير العمل:
1. إعداد السجلات.
2. فحص المتطلبات.
3. تهيئة النظام وقاعدة البيانات.
4. عرض شاشة البداية.
5. تشغيل الواجهة الرئيسية.
6. عند الإغلاق: إنشاء نسخة احتياطية.

---

## 2. customer_issues_window.py (واجهة المستخدم)

### المتغيرات الرئيسية:
- `self.root`: نافذة Tkinter الرئيسية.
- `self.file_manager`: كائن لإدارة الملفات والمرفقات.
- `self.functions`: كائن الوظائف المنطقية (EnhancedFunctions).
- متغيرات الحالة مثل: `current_case_id`, `cases_data`, `filtered_cases`, `basic_data_widgets`, `settings`.

### الدوال والإجراءات:
- **__init__()**: تهيئة النافذة، الخطوط، المتغيرات، ربط الوظائف، بناء الواجهة، تحميل البيانات، ربط أحداث الإغلاق.
- **setup_fonts()**: إعداد الخطوط العربية الاحترافية للواجهة.
- **create_main_layout()**: بناء التخطيط الرئيسي (لوحة جانبية، منطقة عرض رئيسية).
- **create_sidebar()**: بناء اللوحة الجانبية (قائمة الحالات، أزرار الإجراءات، البحث).
- **create_action_buttons()**: أزرار إضافة/حذف حالة، إدارة الموظفين.
- **create_search_filters()**: أدوات البحث والفلترة (سنة، نوع التاريخ، نوع البحث).
- **show_settings_window()**: نافذة إعدادات مسار المرفقات.
- **after_main_layout()**: تحميل البيانات الأولية بعد بناء الواجهة.
- **add_new_case()**: إضافة حالة جديدة.
- **add_attachment()**: إضافة مرفق لحالة.
- **perform_search()**: تنفيذ البحث في الحالات.
- **on_closing()**: معالجة إغلاق البرنامج (حفظ التغييرات/النسخ الاحتياطي).

### الاستدعاءات:
- استدعاء `EnhancedFunctions` من customer_issues_functions.py.
- استدعاء `FileManager` من customer_issues_file_manager.py.
- استدعاء دوال قاعدة البيانات عبر الوظائف المنطقية.

### أجزاء الكود الرئيسية:
- بناء الواجهة (قوائم، تبويبات، حقول بيانات، مرفقات، مراسلات).
- إدارة الأحداث (زر، بحث، إغلاق، إضافة/حذف).
- التعامل مع الإعدادات (config.json).

---

## 3. customer_issues_functions.py (الوظائف المنطقية)

### المتغيرات الرئيسية:
- `self.main_window`: مرجع للنافذة الرئيسية للتفاعل مع عناصر الواجهة.
- `self.categories_data`, `self.status_data`: بيانات التصنيفات والحالات للبحث والعرض.

### الدوال والإجراءات:
- **load_initial_data()**: تحميل السنوات، التصنيفات، الحالات، خيارات الحالة.
- **load_years()**: تحميل السنوات المتاحة من قاعدة البيانات.
- **load_categories()**: تحميل تصنيفات المشاكل من قاعدة البيانات.
- **load_status_options()**: تحميل خيارات الحالة من قاعدة البيانات.
- **load_cases()**: تحميل الحالات (كل السنوات أو سنة محددة).
- **refresh_cases_display()**: تحديث عرض الحالات في الواجهة.
- **create_case_card()**: بناء بطاقة حالة في القائمة الجانبية.
- **select_case()**: اختيار حالة وعرض تفاصيلها.
- **load_case_details()**: تحميل تفاصيل حالة (بيانات، مرفقات، مراسلات، سجل تعديلات).
- **fill_basic_data()**: ملء حقول البيانات الأساسية في الواجهة.
- **add_new_case()**: إضافة حالة جديدة لقاعدة البيانات.
- **perform_search()**: تنفيذ البحث في الحالات.

### الاستدعاءات:
- استدعاء دوال قاعدة البيانات عبر `enhanced_db` (مثل get_cases_by_year, get_categories).
- استدعاء عناصر الواجهة عبر `self.main_window`.

### أجزاء الكود الرئيسية:
- تحميل البيانات من قاعدة البيانات.
- تحديث الواجهة بالبيانات.
- تنفيذ عمليات البحث والتصفية.
- إضافة/تعديل/حذف الحالات والمرفقات والمراسلات.

---

## 4. customer_issues_file_manager.py (إدارة الملفات)

### المتغيرات الرئيسية:
- `self.base_path`: المسار الأساسي لمجلد الملفات (عادة files/).
- `PROJECT_ROOT`: مسار جذر المشروع.

### الدوال والإجراءات:
- **ensure_base_directory()**: التأكد من وجود مجلد الملفات الأساسي.
- **create_case_folder(case_id)**: إنشاء مجلد جديد لحالة.
- **copy_file_to_dedicated_folder(source_path, case_id, attachments_base_path, description)**: نسخ ملف إلى مجلد الحالة.
- **get_attachment_info(file_path, description)**: جلب معلومات ملف مرفق دون نسخه.
- **select_and_copy_file(case_id, description)**: اختيار ونسخ ملف لحالة عبر نافذة حوار.
- **get_file_type(file_name)**: تحديد نوع الملف من الامتداد.
- **get_file_size(file_path)**: حساب حجم الملف بشكل مقروء.
- **open_case_folder(case_id)**: فتح مجلد حالة في النظام.
- **open_file(file_path)**: فتح ملف في النظام.
- **delete_file(file_path)**: حذف ملف من النظام.

### الاستدعاءات:
- استدعاء دوال النظام (os, shutil) لإدارة الملفات والمجلدات.
- استدعاء رسائل واجهة المستخدم (messagebox) عند الحاجة.

### أجزاء الكود الرئيسية:
- إدارة المجلدات (إنشاء، فتح، حذف).
- إدارة المرفقات (نسخ، معلومات، حذف).
- دعم تعدد الأنظمة (Windows, macOS, Linux).

---

## 5. customer_issues_database.py (مدير قاعدة البيانات)

### المتغيرات الرئيسية:
- `self.db_name`: اسم ملف قاعدة البيانات (عادة customer_issues_enhanced.db).

### الدوال والإجراءات:
- **init_database()**: إنشاء الجداول الأساسية إذا لم تكن موجودة (الموظفين، التصنيفات، الحالات، المراسلات، المرفقات، سجل التعديلات).
- **execute_query(query, params=None)**: تنفيذ استعلام SQL عام وإرجاع النتائج.
- **get_connection()**: الحصول على اتصال بقاعدة البيانات.
- **add_case, update_case, delete_case**: إضافة/تعديل/حذف حالة.
- **get_cases_by_year, search_cases, get_case_details**: استعلامات لجلب الحالات.
- **add_attachment, get_attachments, delete_attachment**: إدارة المرفقات.
- **add_correspondence, get_correspondences, delete_correspondence**: إدارة المراسلات.
- **log_action, get_case_audit_log**: إدارة سجل التعديلات.
- **get_employees, add_employee, delete_employee**: إدارة الموظفين.
- **get_categories, get_status_options**: جلب التصنيفات وخيارات الحالة.

### الاستدعاءات:
- استدعاء مكتبة sqlite3 لإدارة قاعدة البيانات.
- استدعاء datetime لحفظ التواريخ.

### أجزاء الكود الرئيسية:
- إنشاء الجداول وربطها بمفاتيح أجنبية.
- تنفيذ جميع العمليات على البيانات (CRUD).
- دعم إدخال بيانات افتراضية (موظفين، تصنيفات).

---

## أمثلة مختصرة على الإجراءات:

- **إضافة حالة جديدة:**
  - من الواجهة: زر "إضافة حالة جديدة" → استدعاء add_new_case() في EnhancedFunctions → إضافة سجل في جدول cases.

- **إضافة مرفق:**
  - من الواجهة: زر "إضافة مرفق" → استدعاء add_attachment() → اختيار ملف → نسخ الملف لمجلد الحالة → إضافة سجل في جدول attachments.

- **بحث عن حالة:**
  - من الواجهة: إدخال معايير البحث → استدعاء perform_search() → جلب النتائج من قاعدة البيانات وتحديث العرض.

---

## ملخص ترابط الأجزاء:
- main.py يهيئ النظام ويشغل الواجهة.
- window.py يبني الواجهة ويتعامل مع المستخدم.
- functions.py ينفذ المنطق ويتعامل مع قاعدة البيانات والملفات.
- file_manager.py يدير المرفقات والمجلدات.
- database.py يدير كل البيانات والعلاقات.

--- 